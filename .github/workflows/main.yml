name: build

on:
  push:
    branches:
      - "*" # run for branches
    tags:
      - "*" # run for tags
  pull_request:
    branches:
      - "*" # run for branches
    tags:
      - "*" # run for tags

env:
  GROUP: weaveworksdemos
  COMMIT: ${{ github.sha }}
  REPO: front-end
  DOCKER_REGISTRY: ghcr.io
  DOCKER_NAME: ghcr.io/${{ github.repository }}
  PUSH_DOCKER_IMAGE: true

jobs:
  basic_test:
    # needs: prepare
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      # PSI: Node 4.x??
      - uses: actions/setup-node@v1
        with:
          node-version: "4.x"

      # PSI: npm ci
      - run: npm install
      # PSI: Unit tests
      # Run node tests in docker image
      - name: Test image
        env:
          DOCKER_BUILDKIT: 1
        run: make test


   # PSI: Integration Test:
    #
    # Run simple test against built container
    #- name: Test docker image
    #  env:
    #    DOCKER_BUILDKIT: 1
    #  run: ./test/container.sh
    # - name: Push to Docker Hub
    #   uses: docker/build-push-action@v1
    #   if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/master'
    #   with:
    #     username: ${{ secrets.DOCKER_USER }}
    #     password: ${{ secrets.DOCKER_PASS }}
    #     repository: ${{ env.GROUP }}/${{ env.REPO }}
    #     tag_with_ref: true
    #     tag_with_sha: true

  build_docker_image:
    needs: basic_test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      # - uses: actions/setup-node@v1
      #   with:
      #     node-version: "4.x"

      # - run: npm install

      - name: Use branch name as Docker image tag
        if: env.GITHUB_HEAD_REF != 'master'
        # git ls-remote --heads -q | grep $(git rev-parse HEAD) | awk '{print $2}' | sed -e 's|refs/heads/||g' | sed -e 's|/|_|g'
        # https://docs.github.com/en/actions/reference/context-and-expression-syntax-for-github-actions
        run: |
          echo "DOCKER_TAG=$(echo $GITHUB_HEAD_REF | sed -e 's|refs/heads/||g' | sed -e 's|/|_|g')" >> $GITHUB_ENV

      # Not final
      - name: Use 'latest' as Docker tag
        if: github.ref == 'refs/heads/master'
        run: |
          echo "DOCKER_TAG=latest" >> $GITHUB_ENV

      - name: Login to GHCR
        uses: docker/login-action@v1
        if: env.PUSH_DOCKER_IMAGE == 'true'
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          registry: ${{ env.DOCKER_REGISTRY }}

      - name: Build + push docker image
        uses: docker/build-push-action@v2
        with:
          push: ${{ env.PUSH_DOCKER_IMAGE }}
          tags: ${{ env.DOCKER_NAME }}:${{ env.DOCKER_TAG }}
